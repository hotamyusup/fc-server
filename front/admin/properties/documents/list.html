<!doctype html>
<html class="no-js" lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Fire Cloud Admin</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="stylesheet" href="/admin/css/vendor.css">
    <link rel="stylesheet" href="/admin/css/app.css">
    <script>
        var themeSettings = (localStorage.getItem('themeSettings')) ? JSON.parse(localStorage.getItem('themeSettings')) :
            {};
        var themeName = themeSettings.themeName || 'red';
        if (themeName) {
            document.write('<link rel="stylesheet" id="theme-style" href="/admin/css/app-' + themeName + '.css">');
        } else {
            document.write('<link rel="stylesheet" id="theme-style" href="/admin/css/app.css">');
        }
    </script>
    <style>
        .item-list .item-check .checkbox + span {
            cursor: pointer;
        }
    </style>
</head>
<body>
<div class="main-wrapper">
    <div class="app" id="app">
        <header class="header">
            <div class="header-block header-block-collapse d-lg-none d-xl-none">
                <button class="collapse-btn" id="sidebar-collapse-btn">
                    <i class="fa fa-bars"></i>
                </button>
            </div>
            <div class="header-block header-block-search"></div>
            <div class="header-block header-block-buttons"></div>
            <div class="header-block header-block-nav">
                <ul class="nav-profile">
                    <li id="notificationNavItem" data-bind="if: ACL.user.notificationSupported"
                        class="notifications new">
                        <a href="" data-toggle="dropdown" aria-expanded="false">
                            <i class="fa" data-bind="css: ACL.user.notificationIcon"></i>
                            <sup data-bind="style: {opacity: ACL.user.notificationsStats.notReadCount ? 1 : 0}">
                                <span class="counter"
                                      data-bind="text: ACL.user.notificationsStats.notReadCount"></span>
                            </sup>
                        </a>
                        <div class="dropdown-menu notifications-dropdown-menu" x-placement="bottom-start"
                             style="position: absolute; will-change: transform; top: 0px; left: 0px; transform: translate3d(-116px, 25px, 0px);">
                            <ul class="notifications-container"
                                data-bind="foreach: ACL.user.notificationsStats.notifications">
                                <li data-bind="style: {opacity: read ? 0.6 : 1}">
                                    <a href="javascript:;;"
                                       data-bind="attr: {id:_id, href:'/admin/notifications/show.html?id='+_id}"
                                       class="notification-item">
                                        <div class="body-col">
                                            <p>
                                                <span data-bind="text: $data.notificationEvent.data.title"
                                                      class="accent"/>
                                            </p>
                                            <p data-bind="text: $data.notificationEvent.data.body"/>
                                        </div>
                                    </a>
                                </li>
                            </ul>
                            <footer>
                                <ul>
                                    <li>
                                        <a href="/admin/notifications/show.html"> View All </a>
                                    </li>
                                </ul>
                            </footer>
                        </div>
                    </li>
                </ul>
            </div>
        </header>
        <aside class="sidebar">
            <div class="sidebar-container">
                <div class="sidebar-header">
                    <div class="brand">Fire Cloud Admin</div>
                </div>
                <nav class="menu">
                    <ul class="sidebar-menu metismenu" id="sidebar-menu">
                        <li class="active">
                            <a href="/admin/properties">
                                <i class="fa fa-th-large"></i> Properties
                            </a>
                        </li>
                        <li data-bind="visible: ACL.isAdmin" style="display: none;">
                            <a href="/admin/users">
                                <i class="fa fa-users"></i> Users
                            </a>
                        </li>
                        <li data-bind="visible: ACL.isAdmin" style="display: none;">
                            <a href="/admin/organizations">
                                <i class="fa fa-dot-circle-o"></i> Organizations
                            </a>
                        </li>
                        <li data-bind="visible: ACL.isAdminOrEmployee" style="display: none;">
                            <a href="/admin/equipments">
                                <i class="fa fa-lightbulb-o"></i> Equipments
                            </a>
                        </li>
                        <li data-bind="visible: ACL.isAdminOrEmployee" style="display: none;">
                            <a href="/admin/constructiontypes">
                                <i class="fa fa-building-o"></i> Construction Types
                            </a>
                        </li>
                        <li data-bind="visible: ACL.isAdminOrEmployee" style="display: none;">
                            <a href="/admin/occupancytypes">
                                <i class="fa fa-home"></i> Occupancy Types
                            </a>
                        </li>
                        <li data-bind="visible: ACL.isAdminOrEmployee" style="display: none;">
                            <a href="/admin/bulkeditor">
                                <i class="fa fa-table"></i> Bulk Editor
                            </a>
                        </li>
                        <li>
                            <a href="/admin/logout.html">
                                <i class="fa fa-lock"></i> Log out
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </aside>
        <div class="sidebar-overlay" id="sidebar-overlay"></div>
        <div class="sidebar-mobile-menu-handle" id="sidebar-mobile-menu-handle"></div>
        <div class="mobile-menu-handle"></div>
        <article class="content dashboard-page">

            <div class="card" data-bind="if: !Documents() || !Property()">
                <div class="card-block">Loading</div>
            </div>
            <section class="section" id="documents" data-bind="if: Documents() && Property()">
                <div class="row">
                    <div class="col-xl-12">

                        <div class="pull-right" style="display: flex; align-items: center; min-height: 46px;">
                            <label>
                                <select data-bind="value: selectedFilter" class="underlined required">
                                    <option selected value="ShowAll">No Filter</option>
                                    <option value="ShowScheduled">Scheduled</option>
                                    <option value="ShowDeactivated">Deactivated</option>
                                    <option value="ShowBounced">Bounced</option>
                                    <option value="ShowDeleted">Deleted</option>
                                    <option value="ShowHandDelivery">Hand Delivery</option>
                                </select>
                                <span style="margin-left: 8px;"><span data-bind="text: totalFilteredCount()"></span> found&nbsp;</span>
                            </label>

                            <label style="margin-left: 10px;">Limit:
                                <select data-bind="value: itemsPerPage" class="underlined required">
                                    <option selected value="50">50</option>
                                    <option value="150">150</option>
                                    <option value="200">200</option>
                                    <option value="250">250</option>
                                    <option value="300">300</option>
                                    <option value="350">350</option>
                                    <option value="-1">No Limit</option>
                                </select>
                            </label>

                            <!-- ko if: pagesCount() > 1 -->
                            <ul class="pagination" data-bind="foreach: new Array(pagesCount())"
                                style="margin-bottom: .5rem; margin-left: .5rem; max-width: 240px;">
                                <li class="page-item" data-bind="css: {active: ($root.pageNum() === ($index()+1))}">
                                    <a class="page-link"
                                       data-bind='text: $index()+1, click: $root.goToPage.bind(this, $index()+1)'
                                       href=""></a>
                                </li>
                            </ul>
                            <!-- /ko -->
                        </div>

                        <div class="title-block">
                            <h3 class="title">
                                <span>Documents:</span>
                                <a data-bind="
                                        text: Property().Title,
                                        attr: {href: '../property.html?i='+Property()._id}
                                    "
                                   href="#"></a>
                            </h3>
                        </div>
                    </div>
                    <div class="col-xl-12">
                        <div class="card items" data-exclude="xs,sm,lg">
                            <div class="card-header bordered">
                                <div class="header-block">
                                    <select data-bind="value: selectedAction" class="underlined required">
                                        <option disabled selected value>Select Action</option>
                                        <option value="Rebuild">Rebuild</option>
                                        <option value="Activate">Activate</option>
                                        <option value="Deactivate">Deactivate</option>
                                        <option value="ExportSelected">Export</option>
                                        <option value="ExportSelectedCSV">Export CSV</option>
                                        <option value="SendNow">Send Now</option>
                                        <option value="Delivered">Mark as Delivered</option>
                                        <option value="Delete">Delete</option>
                                    </select>

                                    <a class="btn btn-primary btn-sm"
                                       data-bind="click: $root.applyActionToSelectedDocuments"
                                       style="margin-left: 10px;"
                                       href="javascript:;;">
                                        Apply action to selected
                                    </a>
                                </div>
                                <div class="header-block pull-right">
                                    <a class="btn btn-primary btn-sm"
                                       style="margin-left: 10px;"
                                       href="javascript:;;"
                                       target="_blank"
                                       data-bind="attr: {href:'/documents/fire-safety/templatesZip?hash=' + User._id + '&PropertyID='+Property()._id}">
                                        Export Document Templates
                                    </a>

                                    <a class="btn btn-primary btn-sm" href="javascript:;;"
                                       data-bind="attr: {href:'create.html?i='+Property()._id}" class="userlink">Add</a>
                                </div>
                            </div>
                            <ul class="item-list striped">
                                <li class="item item-list-header">
                                    <div class="item-row">
                                        <div class="item-col fixed item-col-check">
                                        </div>
                                        <div class="item-col item-col-header fixed">
                                            <div style="width: 14px;">
                                                <span></span>
                                            </div>
                                        </div>
                                        <div class="item-col item-col-header">
                                            <div>
                                                <span>Resident email</span>
                                            </div>
                                        </div>
                                        <div class="item-col item-col-header">
                                            <div>
                                                <span>Resident name</span>
                                            </div>
                                        </div>
                                        <div class="item-col item-col-header">
                                            <div class="no-overflow">
                                                <span>Building</span>
                                            </div>
                                        </div>
                                        <div class="item-col item-col-header">
                                            <div class="no-overflow">
                                                <span>Floor</span>
                                            </div>
                                        </div>
                                        <div class="item-col item-col-header">
                                            <div class="no-overflow">
                                                <span>Unit</span>
                                            </div>
                                        </div>
                                        <div class="item-col item-col-header">
                                            <div class="no-overflow">
                                                <span>Language</span>
                                            </div>
                                        </div>
                                        <div class="item-col item-col-header">

                                            <div class="no-overflow">
                                                <a data-bind="click: $root.sortDocumentsByNotified">
                                                    <span>Notified at</span>
                                                    <i data-bind="css: $root.sortIcons()['notified_at'] || {'fa-sort' : true}" class="fa"></i>
                                                </a>
                                            </div>
                                        </div>
                                        <div class="item-col item-col-header">
                                            <div class="no-overflow">
                                                <span>Status</span>
                                            </div>
                                        </div>
                                        <div class="item-col item-col-header">
                                        </div>
                                        <div class="item-col item-col-header">
                                        </div>
                                        <div class="item-col fixed item-col-check">
                                        </div>
                                    </div>
                                </li>
                                <li class="item item-list-header">
                                    <div class="item-row">
                                        <div class="item-col fixed item-col-check">
                                            <label class="item-check" id="select-all-items">
                                                <input type="checkbox"
                                                       class="checkbox"
                                                       data-bind="checked: $root.selectedAllDocuments">
                                                <span></span>
                                            </label>
                                        </div>
                                        <div class="item-col item-col-header fixed">
                                        </div>
                                        <div class="item-col item-col-header">
                                        </div>
                                        <div class="item-col item-col-header">
                                            <input type="text" placeholder="search by name" data-bind="textInput: $root.residentNameSearch" class="form-control underlined required">
                                        </div>
                                        <div class="item-col item-col-header">
                                            <select data-bind="options: $root.Buildings(), optionsText: 'Title', value: $root.filteredBuildingID, optionsValue: '_id', optionsCaption: 'Select building', event:{ change: $root.buildingFiltered}"
                                                    class="form-control underlined">
                                            </select>
                                        </div>
                                        <div class="item-col item-col-header">
                                            <select data-bind="options: $root.getFloorsByBuildings(), optionsText: 'Title', value: $root.filteredFloorID, optionsValue: '_id', optionsCaption: 'Select floor'"
                                                    class="form-control underlined">
                                            </select>
                                        </div>
                                        <div class="item-col item-col-header">
                                        </div>
                                        <div class="item-col item-col-header">
                                        </div>
                                        <div class="item-col item-col-header">
                                            <p>here</p>
                                            <!---
                                            lorem
                                            ipsum
                                            -->
                                        </div>
                                        <div class="item-col item-col-header">
                                        </div>
                                        <div class="item-col item-col-header">
                                        </div>
                                        <div class="item-col item-col-header">
                                        </div>
                                        <div class="item-col fixed item-col-check">
                                        </div>
                                    </div>
                                </li>
                                <!-- ko foreach: getFilteredDocuments() -->
                                <li class="item" data-bind="style: {opacity: ($data.Status == -1) ? 0.6 : 1}">
                                    <div class="item-row"
                                         data-bind="style: {'background-color': ($parent.selectedDocuments().indexOf($data._id) >= 0) ? '#E6E6E6' : undefined, opacity: $root.isDeactivated($data) ? 0.8 : 1}">
                                        <div class="item-col fixed item-col-check">
                                            <label class="item-check" data-bind="attr: {title: '#'+($index() + 1)}">
                                                <input type="checkbox"
                                                       data-bind="checked: $parent.selectedDocuments, value: $data._id"
                                                       class="checkbox">
                                                <span></span>
                                            </label>
                                        </div>
                                        <div class="item-col no-overflow fixed" title="resident document">
                                            <a class="item-title no-wrap" href="javascript:;;"
                                               data-bind="attr: {href:'/documents/'+$data._id + '.pdf?hash=' + User._id}"><i
                                                    class="fa fa-file"></i></a>
                                        </div>
                                        <div class="item-col no-overflow" title="resident email">
                                            <h4 class="item-title no-wrap" data-bind="text: $data.signer.email"></h4>
                                        </div>
                                        <div class="item-col no-overflow" title="resident name">
                                            <h4 class="item-title no-wrap" data-bind="text: $data.signer.name"></h4>
                                        </div>
                                        <div class="item-col  no-overflow" title="Building">
                                            <h4 class="item-title no-wrap"
                                                data-bind="text: $parent.id2building()[BuildingID] && $parent.id2building()[BuildingID].Title"></h4>
                                        </div>
                                        <div class="item-col no-overflow" title="Floor">
                                            <h4 class="item-title no-wrap"
                                                data-bind="text: $parent.id2floor()[FloorID] && $parent.id2floor()[FloorID].Title"></h4>
                                        </div>
                                        <div class="item-col no-overflow" title="Unit">
                                            <h4 class="item-title no-wrap"
                                                data-bind="text: $data.signer.unit"></h4>
                                        </div>
                                        <div class="item-col no-overflow" title="language">
                                            <h4 class="item-title no-wrap"
                                                data-bind="text: $data.options && $data.options.language"></h4>
                                        </div>
                                        <div class="item-col no-overflow" title="Notified at">
                                            <h4 class="item-title no-wrap"
                                                data-bind="text: $data.notified_at && moment($data.notified_at).format('L')"></h4>
                                        </div>
                                        <div class="item-col no-overflow">
                                            <h4 class="item-title no-wrap" data-bind="if: $data.bounced">Bounced</h4>
                                            <h4 class="item-title no-wrap"
                                                data-bind="if: !$data.bounced && $data.Status === 1">Scheduled</h4>
                                            <h4 class="item-title no-wrap"
                                                data-bind="if: !$data.bounced && $data.Status === 0">Deactivated</h4>
                                        </div>
                                        <div class="item-col text-right">

                                            <!-- ko if: $data.Status === 1 -->
                                            <a class="userlink" data-bind="click: $root.deactivateDocument"
                                               href="javascript:;;">Deactivate</a>
                                            <!-- /ko -->
                                            <!-- ko if: $data.Status !== 1 -->
                                            <a class="userlink" data-bind="click: $root.activateDocument"
                                               href="javascript:;;">Activate</a>
                                            <!-- /ko -->
                                        </div>

                                        <div class="item-col no-overflow">
                                            <!-- ko if: $data.signer && $data.signer.email -->
                                            <a class="userlink" data-bind="click: $root.notifyDocument"
                                               href="javascript:;;">Send now</a>
                                            <!-- /ko -->

                                            <!-- ko if: !($data.signer && $data.signer.email && !$data.handDelivered) -->
                                            <!-- ko if: !$data.handDelivered -->
                                            <a class="userlink" data-bind="click: $root.markHandDeliveredDocument"
                                               href="javascript:;;">Hand Delivered</a>
                                            <!-- /ko -->
                                            <!-- /ko -->
                                        </div>
                                        <div class="item-col fixed item-col-check">
                                            <a class="item-title no-wrap" href="javascript:;;"
                                               data-bind="attr: {href:'edit.html?i=' + $data._id}"><i
                                                    class="fa fa-edit"></i></a>
                                        </div>
                                    </div>
                                </li>
                                <!-- /ko -->
                            </ul>
                        </div>


                        <!-- ko if: pagesCount() > 1 -->
                        <nav class="text-center">
                            <ul class="pagination" data-bind="foreach: new Array(pagesCount())">
                                <li class="page-item" data-bind="css: {active: ($root.pageNum() === ($index()+1))}">
                                    <a class="page-link"data-bind='text: $index()+1, click: $root.goToPage.bind(this, $index()+1)'  href=""></a>
                                </li>
                            </ul>
                        </nav>
                        <!-- /ko -->

                        <!-- ko if: totalFilteredCount() > 20 -->
                        <div class="text-center">
                            <label style="margin-left: 10px;">Limit:
                                <select data-bind="value: itemsPerPage" class="underlined required">
                                    <option selected value="50">50</option>
                                    <option value="150">150</option>
                                    <option value="200">200</option>
                                    <option value="250">250</option>
                                    <option value="300">300</option>
                                    <option value="350">350</option>
                                    <option value="-1">No Limit</option>
                                </select>
                            </label>
                        </div>
                        <!-- /ko -->

                        <!-- /ko -->
                    </div>
                </div>
            </section>
        </article>
        <footer class="footer"></footer>
    </div>
</div>
<!-- Reference block for JS -->
<div class="ref" id="ref">
    <div class="color-primary"></div>
    <div class="chart">
        <div class="color-primary"></div>
        <div class="color-secondary"></div>
    </div>
</div>
<script src="https://www.gstatic.com/firebasejs/7.14.5/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.14.5/firebase-messaging.js"></script>

<script src="/admin/js/config-front.js"></script>
<script src="/admin/js/vendor.js"></script>
<script src="/admin/js/app.js"></script>
<script src="/admin/js/custom.js"></script>
<script src="/admin/js/fcm-init.js"></script>
<script type="text/javascript">
    $(function () {
        Site.init();
        var PropertyID = QueryString("i");
        const ACL = Auth.ACL();

        var allChecked = false;
        var Model = {
            ACL: ACL,

            User: User,

            id2floor: ko.observable(null),
            id2building: ko.observable(null),
            id2document: ko.observable(null),
            Property: ko.observable(null),
            Buildings: ko.observable(null),
            Floors: ko.observable(null),
            Documents: ko.observable(null),

            residentNameSearch: ko.observable(null),
            filteredBuildingID: ko.observable(null),
            filteredFloorID: ko.observable(null),
            selectedAction: ko.observable(null),
            selectedFilter: ko.observable('ShowAll'),
            itemsPerPage: ko.observable(100),
            pageNum: ko.observable(1),
            pagesCount: ko.observable(1),
            totalFilteredCount: ko.observable(0),
            filteredDocuments: ko.observable([]),
            selectedDocuments: ko.observable([]),
            selectedAllDocuments: ko.observable(false),
            sortedFields: ko.observable({}),
            sortIcons: ko.observable({}),
            getFloorsByBuildings() {
                let floorsByBuilding = this.Floors();
                if (this.filteredBuildingID()) {
                    floorsByBuilding = _.filter(this.Floors(), floor => floor.BuildingID === this.filteredBuildingID())
                }
                return floorsByBuilding;
            },
            activateDocument(document) {
                API.activateDocument(document._id, getDocumentsForCurrentProperty)
            },
            deactivateDocument(document) {
                API.deactivateDocument(document._id, getDocumentsForCurrentProperty)
            },
            notifyDocument(document) {
                API.notifyDocument(document._id, getDocumentsForCurrentProperty)
            },
            markHandDeliveredDocument(document) {
                API.updateDocument(document._id, {
                    _id: document._id,
                    handDelivered: true
                }, getDocumentsForCurrentProperty)
            },
            isDeactivated(document) {
                const isDeactivatedStatus = document.Status === 0;
                return !document.bounced && isDeactivatedStatus
            },
            filterDocument(document) {
                const buildingId = this.filteredBuildingID();

                if (buildingId) {
                    if (document.BuildingID !== buildingId) {
                        return false;
                    }
                }

                const floorId = this.filteredFloorID();

                if (floorId) {
                    if (document.FloorID !== floorId) {
                        return false;
                    }
                }

                if (this.residentNameSearch() && this.residentNameSearch().trim().length) {
                    const name = document.signer && document.signer.name;
                    const searchRegExp = new RegExp(this.residentNameSearch(), "i");
                    if (name && name.search(searchRegExp) == -1) {
                        return false;
                    }
                }

                const currentFilter = this.selectedFilter();

                const isScheduledStatus = document.Status === 1;
                const isDeactivatedStatus = document.Status === 0;
                const isDeletedStatus = document.Status === -1;

                switch (currentFilter) {
                    case 'ShowScheduled':
                        return !document.bounced && isScheduledStatus;
                    case 'ShowDeactivated':
                        return !document.bounced && isDeactivatedStatus;
                    case 'ShowBounced':
                        return !!document.bounced && !isDeletedStatus;
                    case 'ShowDeleted':
                        return isDeletedStatus;
                    case 'ShowAll':
                        return !isDeletedStatus;
                    case 'ShowHandDelivery':
                        return !(document && document.signer && document.signer.email);
                    default:
                        return !document.bounced && isScheduledStatus;
                }
            },
            goToPage(pageNum) {
                Model.pageNum(pageNum);
                Model.selectedDocuments([]);
                $(window).scrollTop(0);
            },
            buildingFiltered() {
                this.filteredFloorID(null);
            },

            sortIcon(field) {
                const sortOrder = Model.sortedFields()[field] || 0;
                const icons = {0: "fa-sort", 1: "fa-sort-up", [-1]: "fa-sort-down"};
                const icon = icons[sortOrder];
                return icon;
            },
            sortDocumentsByNotified() {
                this.sortDocuments('notified_at');
            },
            sortDocuments(field) {
                const sortOrder = Model.sortedFields()[field] || 0;
                const toggle = {0: 1, 1: -1, [-1]: 0};
                const nextValue = toggle[sortOrder];
                Model.sortedFields({
                    ...Model.sortedFields(),
                    [field]: nextValue
                });

                const icons = {0: "fa-sort", 1: "fa-sort-up", [-1]: "fa-sort-down"};
                this.sortIcons({
                    ...this.sortIcons(),
                    [field]: {
                        "fa-sort": false,
                        "fa-sort-up": false,
                        "fa-sort-down": false,
                        [icons[nextValue]]: true
                    }
                });
            },
            getFilteredDocuments() {
                const documents = this.Documents();
                let sortedDocuments = documents;

                const sortedFields = Model.sortedFields();
                if (sortedFields['notified_at']) {
                    const sortingFunction = (doc1, doc2) => {
                        if (!doc1.notified_at)  {
                            return sortedFields['notified_at'];
                        }
                        if (!doc2.notified_at)  {
                            return -sortedFields['notified_at'];
                        }
                        const notified1 = moment(doc1.notified_at).format('L');
                        const notified2 = moment(doc2.notified_at).format('L');
                        return sortedFields['notified_at'] === -1
                            ? notified1.localeCompare(notified2)
                            : notified2.localeCompare(notified1);
                    };

                    sortedDocuments = documents.sort(sortingFunction);
                }

                const itemsPerPage = parseInt(this.itemsPerPage());
                const filteredDocuments = [];
                let filteredCounter = 0;

                for (const document of sortedDocuments) {
                    if (itemsPerPage > -1) {
                        if (this.filterDocument(document)) {
                            const pageIndex = this.pageNum() - 1;
                            const insidePageLimit = (filteredCounter >= pageIndex * itemsPerPage)
                                && (filteredCounter < (pageIndex * itemsPerPage + itemsPerPage));

                            if (insidePageLimit) {
                                filteredDocuments.push(document);
                            }
                            filteredCounter++;
                        }
                    } else {
                        if (this.filterDocument(document)) {
                            filteredDocuments.push(document);
                        }
                    }
                }

                this.totalFilteredCount(filteredCounter);

                let pagesCount = 1;
                if (itemsPerPage > -1) {
                    pagesCount = Math.ceil(filteredCounter / itemsPerPage);
                } else {
                    pagesCount = 1;
                }

                if (this.pagesCount() !== pagesCount) {
                    this.pagesCount(pagesCount);
                    this.pageNum(1);
                    return this.getFilteredDocuments();
                }

                // this.pageNum(1);
                Model.selectedDocuments([]);
                this.filteredDocuments(filteredDocuments);

                return filteredDocuments;
            },
            applyActionToSelectedDocuments() {
                const action = this.selectedAction();
                const selectedIds = this.selectedDocuments();
                const documents = _.map(selectedIds, docId => Model.id2document()[docId]);
                if (documents.length) {
                    if (action === 'Rebuild') {
                        API.rebuildDocuments(_.map(documents, ({_id}) => _id), getDocumentsForCurrentProperty);
                        this.selectedAction(null);
                    } else if (action === 'Activate') {
                        API.documentsBatch(_.map(documents, ({_id}) => ({
                            _id,
                            Status: 1
                        })), getDocumentsForCurrentProperty);
                        this.selectedAction(null);
                    } else if (action === 'Deactivate') {
                        API.documentsBatch(_.map(documents, ({_id}) => ({
                            _id,
                            Status: 0
                        })), getDocumentsForCurrentProperty);
                        this.selectedAction(null);
                    } else if (action === 'Delete') {
                        const confirmed = confirm(`Do you want to delete ${documents.length} documents?`);
                        if (confirmed) {
                            API.documentsBatch(_.map(documents, ({_id}) => ({
                                _id,
                                Status: -1
                            })), getDocumentsForCurrentProperty);
                            this.selectedAction(null);
                        }
                    } else if (action === 'Delivered') {
                        API.documentsBatch(_.map(documents, ({_id}) => ({
                            _id,
                            notified_at: moment().format(),
                            handDelivered: true,
                        })), getDocumentsForCurrentProperty);
                        this.selectedAction(null);
                    } else if (action === 'SendNow') {
                        API.documentsNotifyBatch(documents, getDocumentsForCurrentProperty)
                    } else if (action === 'ExportSelected') {
                        API.exportPropertyDocuments(_.map(documents, ({_id}) => _id), PropertyID);
                    } else if (action === 'ExportSelectedCSV') {
                        API.exportPropertyDocumentsCSV(_.map(documents, ({_id}) => _id), PropertyID);
                    }
                }
            },
        };

        let updateUrlParams = true;
        const urlParamsMapping = [
            ['filteredBuildingID', 'BuildingID'],
            ['filteredFloorID', 'FloorID']
        ];

        for (const [modelParamName, urlParamName] of urlParamsMapping) {
            if (Model[modelParamName] && Model[modelParamName].subscribe) {
                Model[modelParamName].subscribe(newModelParamValue => {
                    if (updateUrlParams) {
                        insertUrlParamsDebounced({[urlParamName]: newModelParamValue});
                    }
                });
            }
        }

        function updateModelWithUrlParams() {
            console.log(`window.onpopstate() start`);
            updateUrlParams = false;
            const urlParamNames = urlParamsMapping.map(([_, urlParamName])=> urlParamName);
            const urlParams = readUrlParams(urlParamNames);

            for (const [modelParamName, urlParamName] of urlParamsMapping) {
                const urlParamValue = urlParams[urlParamName];
                Model[modelParamName](urlParamValue);
            }

            console.log(`window.onpopstate() BuildingID end`);
            updateUrlParams = true;
        }
        updateModelWithUrlParams();

        window.onpopstate = updateModelWithUrlParams

        Model.selectedAllDocuments.subscribe(isAllSelected => {
            const selection = [];
            if (isAllSelected) {
                selection.push(...Model.filteredDocuments().map(doc => doc._id));
            }
            Model.selectedDocuments(selection);
        });

        function getDocumentsForCurrentProperty() {
            Model.id2document({});
            Model.selectedDocuments([]);
            API.documents(PropertyID, function (documents) {
                if (!ACL.isAdmin) {
                    documents = _.filter(documents, d => d.Status > -1);
                }
                Model.Documents(documents);
                Model.id2document(_.indexBy(documents, '_id'))
            });
        }

        ko.applyBindings(Model);

        API.property(PropertyID, function (property) {
            Model.Property(property);
            Model.id2building({});
            Model.id2floor({});
            Model.Buildings([]);
            Model.Floors([]);

            _.forEach(property.Buildings, function (building) {
                if (building) {
                    Model.id2building()[building._id] = building;
                    Model.Buildings().push(building);
                    _.forEach(building.Floors, function (floor) {
                        if (floor) {
                            Model.id2floor()[floor._id] = floor;
                            Model.Floors().push(floor);
                        }
                    });
                }
            });
            getDocumentsForCurrentProperty();
        });

    });

</script>
</body>
</html>
